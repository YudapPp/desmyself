<!-- postingan.html dengan CRUD -->
<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Postingan - Krin</title>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage.js"></script>
  <script src="firebase-config.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #f0f0f0; }
    .post { background: white; margin: 10px auto; padding: 15px; max-width: 700px; border-radius: 10px; box-shadow: 0 0 5px #ccc; position: relative; }
    .post img { max-width: 100%; border-radius: 10px; margin-top: 10px; }
    .post small { display: block; margin-top: 5px; color: #666; }
    input, textarea { display: block; margin: 10px auto; padding: 10px; width: 90%; max-width: 500px; }
    button { padding: 10px 20px; background: #2e86de; color: white; border: none; border-radius: 20px; cursor: pointer; margin: 5px; }
    #logoutBtn { float: right; background: #e74c3c; }
    .actions { position: absolute; top: 10px; right: 10px; }
    .actions button { font-size: 12px; padding: 5px 10px; }
    .search-box { text-align: center; margin: 10px; }
    .search-box input { width: 90%; max-width: 300px; padding: 10px; border-radius: 10px; }
  </style>
</head>
<body>
  <button id="logoutBtn" onclick="logout()">Logout</button>
  <h1>ðŸ“¢ Postingan</h1>

  <div class="search-box">
    <input type="text" id="searchInput" placeholder="Cari postingan..." oninput="searchPosts()">
  </div>

  <div id="uploadForm" style="display:none">
    <h3>Buat/Edit Postingan</h3>
    <input type="text" id="title" placeholder="Judul" />
    <textarea id="desc" placeholder="Deskripsi"></textarea>
    <input type="file" id="img" accept="image/*" />
    <input type="hidden" id="editId">
    <button onclick="uploadPost()">Simpan</button>
  </div>

  <div id="posts"></div>

  <script>
    const db = firebase.firestore();
    const storage = firebase.storage();
    const auth = firebase.auth();

    auth.onAuthStateChanged(user => {
      if (user) {
        document.getElementById('uploadForm').style.display = 'block';
        loadPosts();
      } else {
        window.location.href = 'login.html';
      }
    });

    function logout() {
      auth.signOut();
    }

    function uploadPost() {
      const title = document.getElementById('title').value;
      const desc = document.getElementById('desc').value;
      const file = document.getElementById('img').files[0];
      const editId = document.getElementById('editId').value;

      if (file) {
        const storageRef = storage.ref('images/' + Date.now() + '_' + file.name);
        storageRef.put(file).then(snapshot => {
          snapshot.ref.getDownloadURL().then(url => {
            saveToFirestore(title, desc, url, editId);
          });
        });
      } else {
        saveToFirestore(title, desc, '', editId);
      }
    }

    function saveToFirestore(title, desc, image, id = '') {
      const data = { title, desc, image, date: new Date() };
      if (id) {
        db.collection('posts').doc(id).update(data);
      } else {
        db.collection('posts').add(data);
      }
      document.getElementById('title').value = '';
      document.getElementById('desc').value = '';
      document.getElementById('img').value = '';
      document.getElementById('editId').value = '';
    }

    function loadPosts() {
      db.collection('posts').orderBy('date', 'desc').onSnapshot(snapshot => {
        const container = document.getElementById('posts');
        container.innerHTML = '';
        snapshot.forEach(doc => {
          const post = doc.data();
          const id = doc.id;
          container.innerHTML += `
            <div class="post">
              <div class="actions">
                <button onclick="editPost('${id}', '${post.title}', \`${post.desc}\`)" style="background:#f39c12">Edit</button>
                <button onclick="deletePost('${id}')" style="background:#c0392b">Hapus</button>
              </div>
              <h3>${post.title}</h3>
              <p>${post.desc}</p>
              ${post.image ? `<img src="${post.image}" />` : ''}
              <small>${new Date(post.date.seconds * 1000).toLocaleDateString()}</small>
            </div>
          `;
        });
      });
    }

    function deletePost(id) {
      if (confirm('Yakin ingin menghapus postingan ini?')) {
        db.collection('posts').doc(id).delete();
      }
    }

    function editPost(id, title, desc) {
      document.getElementById('title').value = title;
      document.getElementById('desc').value = desc;
      document.getElementById('editId').value = id;
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function searchPosts() {
      const keyword = document.getElementById('searchInput').value.toLowerCase();
      const posts = document.querySelectorAll('.post');
      posts.forEach(post => {
        const text = post.innerText.toLowerCase();
        post.style.display = text.includes(keyword) ? 'block' : 'none';
      });
    }
  </script>
</body>
</html>
